var SilverChat=null;!function($){"use strict";if(top.window.SilverChat)window.SilverChat||(window.SilverChat=top.window.SilverChat);else{if("undefined"==typeof jsxc||"undefined"==typeof Strophe)throw new Error("SilverChat dependencies not defined: jsxc and Strophe");null===window.webContext&&(window.webContext=".");var chatPath=window.webContext+"/chat";if(void 0===(SilverChat={settings:{url:"http://im.silverpeas.net:5280/http-bind/",ice:null,id:"",password:"",domain:"im.silverpeas.net",acl:{groupchat:{creation:!0}},language:"",path:chatPath,avatar:null,notificationLogo:"",selectUser:null,debug:!1},init:function(options){this.settings=$.extend(!0,this.settings,options),this.settings.path+="/jsxc",jsxc.storage.setItem("debug",this.settings.debug),window.top.addEventListener("beforeunload",function(){jsxc.master&&setTimeout(function(){SilverChat.stop()},0)},!1);var jsxcOptions={app_name:"Silverpeas",root:this.settings.path,numberOfMsg:0,autoLang:0===this.settings.language.length,defaultLang:0<this.settings.language.length?this.settings.language:jsxc.options.defaultLang,otr:{enable:!1},xmpp:{url:this.settings.url,domain:this.settings.domain,overwrite:!0,resource:"SilverChat",searchDomain:this.settings.searchDomain},mam:{enable:!0,max:100},favicon:{enable:!1},defaultAvatar:jsxc.gui.avatar.getBuddyAvatar};if(void 0!==SilverChat.settings.ice&&null!==SilverChat.settings.ice&&(jsxcOptions.RTCPeerConfig={iceServers:[{urls:"stun:"+SilverChat.settings.ice.server},{urls:"turn:"+SilverChat.settings.ice.server}]},SilverChat.settings.ice.auth)){var id=SilverChat.settings.id,password=SilverChat.settings.password;SilverChat.settings.ice.user&&(id=SilverChat.settings.ice.user,password=SilverChat.settings.ice.password),jsxcOptions.RTCPeerConfig.iceServers[1].username=id,jsxcOptions.RTCPeerConfig.iceServers[1].credential=password,jsxcOptions.RTCPeerConfig.iceServers[1].credentialType="password"}return jsxc.init(jsxcOptions),this},start:function(){return jsxc.start(this.settings.id+"@"+this.settings.domain,this.settings.password),this},stop:function(){return this.isConnected()?new Promise(function(resolve){jsxc.gui.changePresence("offline",!0),setTimeout(function(){jsxc.triggeredFromElement=!0,jsxc.xmpp.logout(!0),localStorage.clear()},0),$(document).on("SilverChat.stopped",function(){resolve()})}):new Promise(function(resolve){resolve()})},connect:function(){return this.isConnected()||jsxc.xmpp.login(this.settings.id+"@"+this.settings.domain,this.settings.password),this},disconnect:function(){return this.isConnected()&&(jsxc.gui.changePresence("offline",!0),setTimeout(function(){jsxc.xmpp.logout(!1),localStorage.clear()},0)),this},isConnected:function(){return null!==jsxc.xmpp.conn}})||"undefined"==typeof jsxc||"undefined"==typeof $iq||"undefined"==typeof Strophe)throw new Error("SilverChat or JSXC not defined!");if(SilverChat.gui={roster:{BUDDIES:1,GROUP_CHATS:2,NO_MENU:3,_MENU:4,DEFAULT:1,selection:{buddies:[],add:function(bid,callback){for(var i=0;i<this.buddies.length;i++)if(this.buddies[i]===bid)return this;return this.buddies.push(bid),callback&&callback(),this},remove:function(bid,callback){return bid?function(){for(var i=0;i<this.buddies.length;i++)if(this.buddies[i]===bid){this.buddies.splice(i,1),callback&&callback();break}}.call(this):(this.buddies.length=0,callback&&callback()),this},size:function(){return this.buddies.length},empty:function(){return 0===this.buddies.length}},init:function(){$("#silverchat_notice").click(function(event){event.stopPropagation(),jsxc.gui.roster.toggle(jsxc.CONST.SHOWN),SilverChat.gui.roster.toggleMenu(jsxc.CONST.SHOWN)}),$("#silverchat_roster_menu_toggle").click(function(){SilverChat.gui.roster.toggleMenu()}),$("#silverchat_buddies_filter").click(function(){SilverChat.gui.roster.selectTab(SilverChat.gui.roster.BUDDIES)}),$("#silverchat_groupchats_filter").click(function(){SilverChat.gui.roster.selectTab(SilverChat.gui.roster.GROUP_CHATS)}),$("#search_user").click(function(){SilverChat.settings.selectUser(SilverChat.gui.openChatWindow)}),SilverChat.settings.acl.groupchat.creation?(jsxc.debug("Allow groupchat creation and invitation"),$("#new_group_chat, #create_group_chat").click(function(){if(!$(this).hasClass("jsxc_disabled")){var $room=jsxc.gui.dialog.open(jsxc.gui.template.get("chatroom")).find("#jsxc_room");$room.attr("title",$.t("Chat_room_name_pattern")).focus(),$("#new_group_chat_form, #create_group_chat").submit(function(event){event.preventDefault();var name=$room.val()||Strophe.getNodeFromJid(jsxc.xmpp.conn.jid)+"_"+(new Date).getTime(),subject=$("#jsxc_dialog #jsxc_subject").val()||"",room=jsxc.muc.newRoom(name,subject,!0);jsxc.muc.invite(SilverChat.gui.roster.selection.buddies,room,subject),SilverChat.gui.roster.clearSelection()})}})):(jsxc.debug("Disallow groupchat creation and invitation"),$("#new_group_chat, #create_group_chat").remove(),$(".silverchat_invite").remove())},clearSelection:function(){SilverChat.gui.roster.selection.remove(),$(".jsxc_rosteritem.selected").removeClass("selected"),$("#new_group_chat, #create_group_chat").addClass("jsxc_disabled")},toggleMenu:function(state){var actual=jsxc.storage.getUserItem("roster_content");actual>this._MENU&&state===jsxc.CONST.SHOWN||actual<=this._MENU&&state===jsxc.CONST.HIDDEN||(actual>this._MENU||state===jsxc.CONST.HIDDEN?this.selectTab(this.NO_MENU):(actual=this._maskOnceMenuIsShown(actual),this._switchContentTo("#silverchat_roster_menu"),jsxc.storage.setUserItem("roster_content",actual)))},selectTab:function(){var currentElt,otherElt,toTab=jsxc.storage.getUserItem("roster_content");switch(toTab=toTab||this.DEFAULT,0<arguments.length&&(toTab=arguments[0]===this.NO_MENU?this._maskOnceMenuIsHidden(toTab):arguments[0]),toTab){case this.BUDDIES:currentElt="#silverchat_buddies_filter",otherElt="#silverchat_groupchats_filter",$("#silverchat_roster_new_group_chat").hide();break;case this.GROUP_CHATS:currentElt="#silverchat_groupchats_filter",otherElt="#silverchat_buddies_filter",$("#silverchat_roster_new_group_chat").show();break;default:jsxc.error("Unknown roster tab:"+toTab),toTab=this.DEFAULT,this.selectTab(toTab)}$(currentElt).addClass("selected"),$(otherElt).removeClass("selected"),this._filter(toTab),this._switchContentTo("#silverchat_roster_chats"),jsxc.storage.setUserItem("roster_content",toTab)},_maskOnceMenuIsHidden:function(id){return id&this.NO_MENU},_maskOnceMenuIsShown:function(id){return id|this._MENU},_switchContentTo:function(elt){$(".silverchat_roster_content").removeClass("jsxc_state_shown").addClass("jsxc_state_hidden"),$(elt).removeClass("jsxc_state_hidden").addClass("jsxc_state_shown")},_filter:function(contentType){jsxc.gui.showInBuddyList(contentType===this.BUDDIES?"chat":"groupchat")}},init:function(){jsxc.debug("Init SilverChat GUI"),SilverChat.gui.roster.init(),"function"!=typeof SilverChat.settings.selectUser&&$("#search_user").remove(),SilverChat.gui.roster.selectTab(SilverChat.gui.roster.NO_MENU)},openChatWindow:function(jid,alias){var bid=jsxc.jidToBid(jid);if(jsxc.storage.getUserItem("buddylist").indexOf(bid)<0)if(jsxc.debug("Add user "+jid+" into my roster"),jsxc.master){var unknown=jsxc.storage.getUserItem("unknown")||[];unknown.push(bid),jsxc.storage.setUserItem("unknown",unknown);var iq=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:jid,name:alias||Strophe.getNodeFromJid(jid)}).c("group").t("xmpp");jsxc.xmpp.conn.sendIQ(iq),jsxc.storage.removeUserItem("add_"+bid)}else jsxc.storage.setUserItem("add_"+bid,{username:jid,alias:alias||Strophe.getNodeFromJid(jid)});else jsxc.gui.window.open(bid)},_selectBuddy:function(bid,buddy,rosteritem){var data=jsxc.storage.getUserItem("buddy",bid);null!==data&&"none"!==data.sub&&(rosteritem.hasClass("selected")?SilverChat.gui.roster.selection.remove(bid,function(){rosteritem.removeClass("selected"),rosteritem.find("#silverchat_select_text").text($.t("Select_Buddy"))}):SilverChat.gui.roster.selection.add(bid,function(){rosteritem.addClass("selected"),rosteritem.find("#silverchat_select_text").text($.t("Unselect_Buddy"))}),SilverChat.gui.roster.selection.empty()?($("#new_group_chat, #create_group_chat").addClass("jsxc_disabled"),$(".silverchat_invite").parent().addClass("jsxc_disabled")):1===SilverChat.gui.roster.selection.size()&&($("#new_group_chat, #create_group_chat").removeClass("jsxc_disabled"),$(".silverchat_invite").parent().removeClass("jsxc_disabled")))},_setRosterBuddyActions:function(bid,buddy,rosteritem){"none"!==buddy.sub&&rosteritem.find(".jsxc_delete").remove(),SilverChat.settings.acl.groupchat.creation&&(rosteritem.attr("draggable",!0).on("dragstart",function(e){e.originalEvent.dataTransfer.setData("text/plain",bid)}),rosteritem.find("div.jsxc_menu ul").append($("<li>").append($("<a>").attr("href","#").addClass("silverchat_select").click(function(event){event.stopPropagation(),SilverChat.gui._selectBuddy(bid,buddy,rosteritem),rosteritem.find("div.jsxc_menu").removeClass("jsxc_open")}).append($("<span>").addClass("jsxc_icon jsxc_bookmarkicon").text("")).append($("<span>").attr("id","silverchat_select_text").text($.t("Select_Buddy"))))),rosteritem.off("click"),rosteritem.click(function(event){if(!event.ctrlKey)return SilverChat.gui.roster.clearSelection(),void jsxc.gui.window.open(bid);SilverChat.gui._selectBuddy(bid,buddy,rosteritem)}))}},$(document).on("add.roster.jsxc",function(event,bid,buddy,rosteritem){if(jsxc.debug("A new "+buddy.type+" is added in the roster as "+buddy.jid),"chat"===buddy.type){SilverChat.gui._setRosterBuddyActions(bid,buddy,rosteritem);var unknown=jsxc.storage.getUserItem("unknown")||[];jsxc.storage.removeUserItem("unknown");for(var i=0;i<unknown.length;i++)jsxc.gui.window.open(unknown[i])}SilverChat.gui.roster.selectTab(SilverChat.gui.roster.NO_MENU)}),$(document).on("receive.invitation.silverchat",function(event,buddy,roomjid,subject){var name=Strophe.getNodeFromJid(roomjid);jsxc.debug("Invation to "+name+" received from "+buddy+' for "'+subject+'"'),jsxc.storage.setUserItem("member",roomjid,{}),jsxc.muc.join(roomjid,Strophe.getNodeFromJid(jsxc.xmpp.conn.jid),null,name,subject,!0,!0),jsxc.notification.notify({title:$.t("New_invitation",{sender:buddy,room:name}),msg:subject||"",source:buddy})}),$(document).on("init.window.jsxc",function(event,chatWindow){var data=chatWindow.data(),bid=jsxc.jidToBid(data.jid),roomdata=jsxc.storage.getUserItem("buddy",bid);"groupchat"===roomdata.type&&roomdata.owner&&(chatWindow.on("dragover",function(e){e.preventDefault()}).on("drop",function(e){e.preventDefault();var bid=e.originalEvent.dataTransfer.getData("text/plain"),room=chatWindow.data("bid");jsxc.muc.invite([bid],room,roomdata.subject||"")}),chatWindow.find("div.jsxc_menu ul").prepend($("<li>").append($("<a>").attr("href","#").addClass("jsxc_disabled").click(function(){if(!$(this).hasClass("jsxc_disabled")){var room=chatWindow.data("bid"),roomdata=jsxc.storage.getUserItem("buddy",room);jsxc.muc.invite(SilverChat.gui.roster.selection.buddies,room,roomdata.subject||""),SilverChat.gui.roster.clearSelection()}}).append($("<span>").addClass("silverchat_invite").attr("title",$.t("Help_Invite")).text($.t("Invite_To_Group_Chat"))))))}),$(document).on("disconnected.jsxc",function(){$(document).off("disconnected.jsxc",this),jsxc.triggeredFromElement&&($("#silverchat_roster").remove(),setTimeout(function(){$(document).trigger("SilverChat.stopped")},0))}),jsxc.gui.template.chatroom='<h3 data-i18n="New_Group_Chat"></h3>\n<div class="form-horizontal">\n  <form id="new_group_chat_form">\n  <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_room" data-i18n="Group_Chat"></label>\n      <div class="col-sm-8">\n         <input type="text" name="room" id="jsxc_room" class="form-control" autocomplete="off"\n                pattern="^[^\\x27\\x22&\'\\\\\\/:,;!\\?<>@\\s\\u00C0-\\u017F]+" autofocus />\n      </div>\n   </div>\n  <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_subject" data-i18n="Reason"></label>\n      <div class="col-sm-8">\n         <input type="text" name="subject" id="jsxc_subject" class="form-control" autocomplete="off" />\n      </div>\n   </div>\n  <div class="jsxc_msg"></div>\n  <br/>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <span class="jsxc_warning"></span>\n         <button class="btn btn-default jsxc_close" data-i18n="Close"></button>\n         <button class="btn btn-success jsxc_confirm" data-i18n="Confirm"></button>\n      </div>\n   </div>\n  </form>\n</div>',jsxc.gui.template.newchat='<h3 data-i18n="New_Chat"></h3>\n<p>\n  <span data-i18n="You_have_received_message_from_"></span><b class="jsxc_their_jid"></b>.\n</p>\n<button class="btn btn-primary jsxc_approve pull-right" data-i18n="Approve"></button>\n<button class="btn btn-default jsxc_deny pull-right" data-i18n="Deny"></button>\n',jsxc.gui.template.roster='<div id="silverchat_roster">\n\n  \x3c!-- the roaster\'s header (the title bar) --\x3e\n  <div id="silverchat_roster_header" class="silverchat_roster_toggle">\n    <span class="silverchat_logo"></span>\n    <div id="silverchat_notice">\n      <span></span>\n    </div>\n  </div>\n\n  \x3c!-- the roaster\'s body (its content) --\x3e\n  <div id="silverchat_roster_body">\n\n    \x3c!-- two tabs: one listing the buddies of the connected user, another listing the group chats --\x3e\n    <div id="silverchat_roster_tabs">\n      <a id="silverchat_buddies_filter" data-i18n="Buddies"></a>\n      <a id="silverchat_groupchats_filter" data-i18n="Group Chats"></a>\n      <span id="silverchat_roster_menu_toggle"></span>\n    </div>\n\n    \x3c!-- the content of the active tab --\x3e\n    <div id="silverchat_roster_content">\n\n      \x3c!-- first, the content of the roaster menu overrides the content of the active tab --\x3e\n      <div id="silverchat_roster_menu" class="silverchat_roster_content jsxc_state_hidden">\n        <div class="silverchat_title" data-i18n="Menu"></div>\n        <span id="search_user" class="silverchat_menu_item" data-i18n="Search_user"></span>\n        <div class="jsxc-content-separator"></div>\n        <span id="create_group_chat" class="silverchat_menu_item jsxc_disabled" data-i18n="New_Group_Chat;[title]Help_New_Chat"></span>\n        <div class="jsxc-content-separator"></div>\n        <div class="silverchat_title" data-i18n="Events"></div>\n        <div id="jsxc_notice">\n          <span></span>\n          <div class="jsxc_inner">\n            <ul class="silverchat_menu_item"></ul>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- jsxc renders into a single container both the buddies and the connected groupchats --\x3e\n      <div id="silverchat_roster_chats" class="silverchat_roster_content">\n        <ul id="jsxc_buddylist"></ul>\n    </div>\n\n  </div>\n\n  <div class="jsxc-content-separator"></div>\n\n  <div id="silverchat_roster_new_group_chat">\n      <span id="new_group_chat" class="silverchat_menu_item jsxc_disabled" data-i18n="New_Group_Chat;[title]Help_New_Group_Chat"></span></div>\n  </div>\n\n  <div id="silverchat_roster_footer" class="jsxc_bottom jsxc_presence jsxc_rosteritem" data-bid="own">\n    <div id="jsxc_presence">\n      <span data-i18n="Offline">Offline</span>\n      <div class="jsxc_inner">\n        <ul>\n          <li data-pres="online" class="jsxc_online" data-i18n="Online"></li>\n          <li data-pres="chat" class="jsxc_chat" data-i18n="Chatty"></li>\n          <li data-pres="away" class="jsxc_away" data-i18n="Away"></li>\n          <li data-pres="xa" class="jsxc_xa" data-i18n="Extended_away"></li>\n          <li data-pres="dnd" class="jsxc_dnd" data-i18n="dnd"></li>\n          <li data-pres="offline" class="jsxc_offline" data-i18n="Offline"></li>\n        </ul>\n      </div>\n    </div>\n  </div>\n</div>\n',jsxc.gui.template.videochat='<div id="jsxc_webrtc">\n  <a class="silverchat_videochat_close"></a>\n  <div class="jsxc_videoContainer">\n\n    <div class="jsxc_status"></div>\n\n    <video class="jsxc_localvideo" autoplay></video>\n    <video class="jsxc_remotevideo" autoplay></video>\n\n    <div class="bubblingG">\n      <span id="bubblingG_1"> </span> <span id="bubblingG_2"> </span> <span id="bubblingG_3"> </span>\n    </div>\n\n    <div class="jsxc_noRemoteVideo">\n      <div>\n        <div></div>\n        <p data-i18n="No_video_signal"></p>\n        <div></div>\n      </div>\n    </div>\n\n    <div class="jsxc_controlbar jsxc_visible">\n      <div>\n        <div class="jsxc_hangUp jsxc_videoControl" />\n        <div class="jsxc_toggleVideo jsxc_videoControl"/>\n        <div class="jsxc_fullscreen jsxc_videoControl" />\n      </div>\n    </div>\n  </div>\n\n</div>\n',void 0===SilverChat||"undefined"==typeof jsxc||"undefined"==typeof Strophe)throw new Error("SilverChat or JSXC not defined!");$(document).off("init.window.jsxc",jsxc.muc.initWindow).on("init.window.jsxc",function(event,win){jsxc.muc.initWindow(event,win);var conf=win.find(".jsxc_settings ul li a.jsxc_configure");1<=conf.length&&conf.parent().remove()}),$(document).ready(function(){$(document).off("init.window.jsxc",jsxc.webrtc.initWindow).on("init.window.jsxc",function(event,win){null===SilverChat.settings.ice||void 0===SilverChat.settings.ice?jsxc.debug("ICE service not found: video chat disabled!"):(jsxc.debug("ICE service for video chat: "+SilverChat.settings.ice.server),jsxc.webrtc.initWindow(event,win))})}),SilverChat.engine={withListOfRoomsDo:function(handler){var timerId=setInterval(function(){if(jsxc.options.get("muc")){clearInterval(timerId);var server=jsxc.options.get("muc").server;jsxc.xmpp.conn.muc.listRooms(server,function(stanza){var rooms=[];$(stanza).find("item").each(function(){var rjid=$(this).attr("jid").toLowerCase();rooms.push(rjid)}),handler(rooms)},function(stanza){var errTextMsg=$(stanza).find("error text").text()||null;jsxc.warn("Could not load rooms",errTextMsg)})}},1e3)}},jsxc.__jidToBid=jsxc.jidToBid,jsxc.jidToBid=function(jid){return null==jid?jid:jsxc.__jidToBid(jid)},jsxc.gui.roster.init=function(){var roster=jsxc.gui.template.get("roster");if(0===$("#"+roster.attr("id")).length){$(jsxc.options.rosterAppend+":first").append(roster),jsxc.options.get("hideOffline")&&$("#jsxc_buddylist").addClass("jsxc_hideOffline"),SilverChat.gui.init(),$("#silverchat_roster_header.silverchat_roster_toggle").click(function(event){event.isPropagationStopped()||jsxc.gui.roster.toggle()}),$("#jsxc_presence li").click(function(){var pres=$(this).data("pres");"offline"===pres?SilverChat.disconnect():(SilverChat.isConnected()||SilverChat.connect(),jsxc.gui.changePresence(pres))}),$("#jsxc_buddylist").slimScroll({distance:"3px",width:$("#jsxc_buddylist").width()+"px",color:"#fff",opacity:"0.5"}),$("#silverchat_roster > .jsxc_bottom > div").each(function(){jsxc.gui.toggleList.call($(this))});var rosterState=jsxc.storage.getUserItem("roster")||"hidden";$("#silverchat_roster").addClass("jsxc_state_"+rosterState),$("#jsxc_windowList").addClass("jsxc_roster_"+rosterState);var pres=jsxc.storage.getUserItem("presence")||"online";$("#jsxc_presence > span").text($("#jsxc_presence .jsxc_"+pres).text()),jsxc.gui.updatePresence("own",pres),jsxc.gui.tooltip("#silverchat_roster"),jsxc.notice.load(),jsxc.gui.roster.ready=!0,$(document).trigger("ready.roster.jsxc",[rosterState]),$(document).trigger("ready-roster-jsxc",[rosterState])}},jsxc.gui.roster.toggle=function(state){var duration,roster=$("#silverchat_roster"),wl=$("#jsxc_windowList");return state=state||(jsxc.storage.getUserItem("roster")===jsxc.CONST.HIDDEN?jsxc.CONST.SHOWN:jsxc.CONST.HIDDEN),jsxc.storage.setUserItem("roster",state),roster.removeClass("jsxc_state_hidden jsxc_state_shown").addClass("jsxc_state_"+state),wl.removeClass("jsxc_roster_hidden jsxc_roster_shown").addClass("jsxc_roster_"+state),duration=1e3*parseFloat(roster.css("transitionDuration")||0),setTimeout(function(){jsxc.gui.updateWindowListSB()},duration),$(document).trigger("toggle.roster.jsxc",[state,duration]),duration},jsxc.gui.avatar.getBuddyAvatar=function(jid){var data=jsxc.storage.getUserItem("buddy",jid);null!==data&&"groupchat"===data.type?jsxc.gui.__avatarPlaceholder($(this).find(".jsxc_avatar"),jid):jsxc.gui.avatarPlaceholder($(this).find(".jsxc_avatar"),jid)},jsxc.gui.__avatarPlaceholder=jsxc.gui.avatarPlaceholder,jsxc.gui.avatarPlaceholder=function(el,seed,text){var buddy=seed||text;buddy=Strophe.getNodeFromJid(buddy)||buddy;var avatar=new Image;switch(avatar.onerror=function(){jsxc.gui.__avatarPlaceholder(el,seed,text)},avatar.onload=function(){el.removeAttr("style"),el.css({"background-image":"url("+avatar.src+")","text-indent":"999px"})},typeof SilverChat.settings.avatar){case"function":avatar.src=SilverChat.settings.avatar.call(buddy);break;case"string":avatar.src=SilverChat.settings.avatar+"/"+buddy+".jpg";break;default:avatar.onerror()}},jsxc.gui.showInBuddyList=function(type){"groupchat"===type||"chat"===type?$("#jsxc_buddylist li.jsxc_rosteritem").each(function(){$(this).data("type")===type?$(this).show():$(this).hide()}):jsxc.error("Unknown jsxc data type in buddy list:"+type)},jsxc.gui.showUnknownSender=function(bid,userName){jsxc.gui.dialog.open(jsxc.gui.template.get("newchat"),{noClose:!0});var userFullName=void 0!==userName&&0<userName.length?userName:Strophe.getNodeFromJid(bid);$("#jsxc_dialog .jsxc_their_jid").text(userFullName),$("#jsxc_dialog .jsxc_deny").click(function(){jsxc.storage.removeUserItem("chat",bid),jsxc.gui.dialog.close()}),$("#jsxc_dialog .jsxc_approve").click(function(){jsxc.gui.dialog.close(),jsxc.storage.saveBuddy(bid,{jid:bid,name:userFullName,status:0,sub:"none",res:[]});for(var chat=jsxc.storage.getUserItem("chat",bid)||[],i=0;i<chat.length;i++)jsxc.gui.window.postMessage(chat[i]);jsxc.storage.removeUserItem("chat",bid),jsxc.gui.window.open(bid)})},jsxc.gui.showVideoWindow=function(jid){var self=jsxc.webrtc;jsxc.gui.dialog.close(),$("body").append(jsxc.gui.template.get("videochat").addClass("jsxc_state_shown"));var localVideo=$("#jsxc_webrtc .jsxc_localvideo"),remoteVideo=$("#jsxc_webrtc .jsxc_remotevideo");return localVideo[0].muted=!0,localVideo[0].volume=0,self.localStream&&self.attachMediaStream(localVideo,self.localStream),self.remoteStream&&(self.attachMediaStream(remoteVideo,self.remoteStream),$("#jsxc_webrtc .jsxc_"+(0<self.remoteStream.getVideoTracks().length?"remotevideo":"noRemoteVideo")).addClass("jsxc_deviceAvailable")),$("#jsxc_webrtc .jsxc_hangUp").click(function(){jsxc.webrtc.hangUp("success")}),$("#jsxc_webrtc .jsxc_fullscreen").click(function(){$("#jsxc_webrtc .jsxc_videoContainer").fullscreen()}),$("#jsxc_webrtc .jsxc_videoContainer").click(function(){$("#jsxc_webrtc .jsxc_controlbar").toggleClass("jsxc_visible")}),$("#jsxc_webrtc .jsxc_toggleVideo").click(function(){$("#jsxc_webrtc").hasClass("jsxc_state_shown")?$("#jsxc_webrtc").removeClass("jsxc_state_shown").addClass("jsxc_state_hidden"):$("#jsxc_webrtc").removeClass("jsxc_state_hidden").addClass("jsxc_state_shown")}),jsxc.gui.window.open(jsxc.jidToBid(jid)),$("#jsxc_webrtc")},jsxc.gui.closeVideoWindow=function(){$("#jsxc_webrtc").remove()},jsxc.notification.__notify=jsxc.notification.notify,jsxc.notification.notify=function(title,msg,d,force,soundFile,loop,source){var notifParams;if((notifParams=null!==title&&"object"==typeof title?title:{title:title,msg:msg,duration:d,force:force,soundFile:soundFile,loop:loop,source:source}).icon=SilverChat.settings.notificationLogo,"string"==typeof notifParams.source){var data=jsxc.storage.getUserItem("buddy",notifParams.source);if(null!==data){var src=jsxc.storage.getUserItem("avatar",data.avatar);"string"==typeof src&&"0"!==src&&(notifParams.icon=src)}else notifParams.source=null}jsxc.notification.__notify(notifParams)},jsxc.notice.__add=jsxc.notice.add,jsxc.notice.add=function(data,fnName,fnParams,id){null==fnParams&&(fnParams=[]);function sendNotice(stanza){var userFullName=null!=stanza?$(stanza).find("vCard > FN").text():"";data.description+=userFullName,fnParams.push(userFullName),jsxc.notice.__add(data,fnName,fnParams,id),$("#silverchat_notice > span").text(jsxc.notice._num),$("#jsxc_notice ul").addClass("silverchat_menu_item")}if(data.msg===$.t("Unknown_sender")&&1===fnParams.length){var bid=fnParams[0];data.msg=$.t("Friendship_request"),data.description=$.t("You_have_received_message_from_"),jsxc.xmpp.loadVcard(bid,sendNotice,sendNotice)}else sendNotice()},jsxc.notice.__remove=jsxc.notice.remove,jsxc.notice.remove=function(nid){jsxc.notice.__remove(nid),$("#silverchat_notice > span").text(jsxc.notice._num||"")},jsxc.muc.__init=jsxc.muc.init,jsxc.muc.init=function(o){jsxc.muc.__init(o),jsxc.muc.onGroupchatMessageHandlerRef&&jsxc.muc.conn.deleteHandler(jsxc.muc.onGroupchatMessageHandlerRef),jsxc.muc.onGroupchatMessageHandlerRef=jsxc.muc.conn.addHandler(jsxc.muc.myOnGroupchatMessage,null,"message","groupchat"),jsxc.muc.conn.addHandler(jsxc.muc.onDirectInvitation,"jabber:x:conference","message")},jsxc.muc.myOnGroupchatMessage=function(message){var id=$(message).attr("id");if(id&&jsxc.el_exists(jsxc.Message.getDOM(id)))return!0;var from=$(message).attr("from"),htmlBodyElement=$(message).find('body[xmlns="'+Strophe.NS.XHTML+'"]').first(),body=$(message).find("body:first").text(),room=jsxc.jidToBid(from),nickname=Strophe.unescapeNode(Strophe.getResourceFromJid(from)),roomdata=jsxc.storage.getUserItem("buddy",room);if(""!==body){var delay=$(message).find('delay[xmlns="urn:xmpp:delay"]'),stampDate=0<delay.length?new Date(delay.attr("stamp")):new Date,stamp=stampDate.getTime(),member=jsxc.storage.getUserItem("member",room)||{},sender={name:nickname},direction=jsxc.Message.IN;stampDate<(roomdata.joinedAt?new Date(roomdata.joinedAt):0)?roomdata.nickname===nickname&&(direction=jsxc.Message.PROBABLY_OUT):member[nickname]&&"string"==typeof member[nickname].jid&&(sender.jid=member[nickname].jid),jsxc.gui.window.init(room);var attachment=jsxc.xmpp.getAttachmentFromHtmlBody(htmlBodyElement);attachment&&(body=null),jsxc.gui.window.postMessage({bid:room,direction:direction,msg:body,stamp:stamp,sender:sender,attachment:attachment})}return!0},jsxc.muc.onDirectInvitation=function(stanza){if(!(0<$(stanza).find("x[xmlns='"+Strophe.NS.MUC_USER+"']").length)){var sender=Strophe.getNodeFromJid($(stanza).attr("from")),invitation=$(stanza).find("x[xmlns='jabber:x:conference']"),roomjid=invitation.attr("jid"),reason=invitation.attr("reason")||"";return SilverChat.engine.withListOfRoomsDo(function(rooms){0<=rooms.indexOf(roomjid)&&(jsxc.debug("Direct invitation to the group chat "+roomjid+" received from "+sender),$(document).trigger("receive.invitation.silverchat",[sender,roomjid,reason]))}),!0}},jsxc.muc.invite=function(buddies,room,reason){for(var i=0;i<buddies.length;i++)jsxc.debug("Invite user "+buddies[i]+" to the group chat "+room),jsxc.muc.conn.muc.directInvite(room,buddies[i],reason||""),jsxc.muc.conn.muc.member(room,buddies[i],"")},jsxc.muc.newRoom=function(name,subject,persistent){if(name){var room=function(str){for(var defaultDiacriticsRemovalMap=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}],i=0;i<defaultDiacriticsRemovalMap.length;i++)str=str.replace(defaultDiacriticsRemovalMap[i].letters,defaultDiacriticsRemovalMap[i].base);return str}(name.replace(/@.+/,"").replace(/ /g,"_").toLowerCase())+"@"+jsxc.options.get("muc").server,reason=subject||"";jsxc.storage.setUserItem("member",room,{}),jsxc.muc.join(room,Strophe.getNodeFromJid(jsxc.xmpp.conn.jid),null,name,reason,!0,!0);var roomdata=jsxc.storage.getUserItem("buddy",room)||{};return roomdata.config=jsxc.muc.CONST.ROOMCONFIG.INSTANT,roomdata.owner=!0,roomdata.persistent=persistent,jsxc.storage.setUserItem("buddy",room,roomdata),room}},$(document).on("status.muc.jsxc",function(event,code,room,nickname,data){var roomdata=jsxc.storage.getUserItem("buddy",room);"201"===code?roomdata.persistent&&(jsxc.debug("Room "+roomdata.name+" created by "+nickname+": save specific silverchat configuration"),jsxc.muc.conn.muc.configure(room,function(stanza){var form=Strophe.x.Form.fromXML(stanza);!function(form,roomdata){for(var i=0;i<form.fields.length;i++)switch(form.fields[i].var){case"muc#roomconfig_roomname":form.fields[i].values=[roomdata.name];break;case"muc#roomconfig_roomdesc":form.fields[i].values=[roomdata.subject];break;case"muc#roomconfig_persistentroom":case"muc#roomconfig_allow_subscription":case"muc#roomconfig_enablelogging":form.fields[i].values=[1];break;case"muc#roomconfig_allowinvites":case"muc#roomconfig_moderatedroom":case"muc#roomconfig_publicroom":form.fields[i].values=[0];break;case"muc#roomconfig_whois":form.fields[i].values=["anyone"]}}(form,roomdata),jsxc.muc.conn.muc.saveConfiguration(room,form,function(){},function(response){jsxc.error("Error while configuring room "+room,response)})},function(response){jsxc.error("Error while loading configuration of room "+room,response)})):"110"===code&&(jsxc.debug("MUC affiliation of "+nickname+" to room "+room+": "+data.affiliation),data.affiliation===jsxc.muc.CONST.AFFILIATION.OWNER&&(roomdata.owner=!0,jsxc.storage.setUserItem("buddy",room,roomdata)))}),$(document).on("presence.jsxc",function(event,from,status,presence){var room=jsxc.jidToBid(from),roomdata=jsxc.storage.getUserItem("buddy",room),xdata=$(presence).find('x[xmlns^="'+Strophe.NS.MUC+'"]');if(jsxc.muc.conn.muc.roomNames.indexOf(room)<0||0===xdata.length)return!0;jsxc.debug("ROOM STATUS IS "+status),0===status&&0<xdata.find("destroy").length&&setTimeout(function(){jsxc.debug("Room "+room+" has been deleted"),null!==roomdata&&roomdata.bookmarked?jsxc.xmpp.bookmarks.delete(room,!1):jsxc.gui.roster.purge(room)},1e3)}),jsxc.xmpp.bookmarks.loadFromRemote=function(){SilverChat.engine.withListOfRoomsDo(function(rooms){jsxc.debug("Load bookmarks from pubsub");var bookmarks=jsxc.xmpp.conn.bookmarks;bookmarks.get(function(stanza){var bl=jsxc.storage.getUserItem("buddylist");$(stanza).find("conference").each(function(){var conference=$(this),room=conference.attr("jid"),roomName=conference.attr("name")||room,autojoin=conference.attr("autojoin")||!1,nickname=conference.find("nick").text();nickname=0<nickname.length?nickname:Strophe.getNodeFromJid(jsxc.xmpp.conn.jid),"true"===autojoin?autojoin=!0:"false"===autojoin&&(autojoin=!1);var data=jsxc.storage.getUserItem("buddy",room)||{};data=$.extend(data,{jid:room,name:roomName,sub:"both",status:0,type:"groupchat",state:jsxc.muc.CONST.ROOMSTATE.INIT,subject:null,bookmarked:!0,autojoin:autojoin,nickname:nickname}),0<=rooms.indexOf(room)?(jsxc.storage.setUserItem("buddy",room,data),bl.push(room),jsxc.gui.roster.add(room),autojoin&&(jsxc.debug("auto join "+room),jsxc.xmpp.conn.muc.join(room,nickname))):(jsxc.debug("Bookmarked room "+room+" has been deleted"),jsxc.xmpp.bookmarks.delete(room,!1))}),jsxc.storage.setUserItem("buddylist",bl)},function(stanza){var err=jsxc.xmpp.bookmarks.parseErr(stanza);"item-not-found"===err.reasons[0]?(jsxc.debug("create bookmark node"),bookmarks.createBookmarksNode(function(){jsxc.debug("Bookmark node created.")},function(){jsxc.debug("Could not create bookmark node.")})):jsxc.debug("[XMPP] Could not create bookmark: "+err.type,err.reasons)})})},jsxc.xmpp.mam.nextMessages=function(bid){var to,buddyData=jsxc.storage.getUserItem("buddy",bid)||{};"groupchat"===buddyData.type&&(to=bid);var self=jsxc.xmpp.mam,lastArchiveUid=buddyData.lastArchiveUid,queryId=self.conn.getUniqueId(),mamOptions=jsxc.options.get("mam")||{},history=jsxc.storage.getUserItem("history",bid)||[];if(buddyData.archiveExhausted)jsxc.debug("No more archived messages.");else{var queryOptions={queryid:queryId,before:lastArchiveUid||"",onMessage:function(){var args=Array.from(arguments);return args.unshift(bid),self.onMessage.apply(this,args),!0},onComplete:function(){var args=Array.from(arguments);return args.unshift(bid),self.onComplete.apply(this,args),!0}};void 0===to&&(queryOptions.with=bid);var oldestMessageId=history[history.length-1];if(oldestMessageId&&!lastArchiveUid){var oldestMessage=new jsxc.Message(oldestMessageId);queryOptions.end=new Date(oldestMessage.stamp).toISOString()}mamOptions.max&&(queryOptions.max=mamOptions.max),jsxc.debug("MAM => Messages query options for "+bid+": ",queryOptions),self.conn.mam.query(to,queryOptions)}},jsxc.xmpp.mam.onMessage=function(bid,stanza){jsxc.debug("MAM => message for "+bid+": ",stanza);var result=(stanza=$(stanza)).find('result[xmlns="'+Strophe.NS.MAM+'"]'),queryId=result.attr("queryid");if(1===result.length){var forwarded=result.find('forwarded[xmlns="'+jsxc.CONST.NS.FORWARD+'"]'),message=forwarded.find("message"),messageId=$(message).attr("id");if(1===message.length){var direction=jsxc.xmpp.mam.getMessageDirection(bid,$(message));if(null!==direction){var delay=forwarded.find('delay[xmlns="urn:xmpp:delay"]'),stamp=0<delay.length?new Date(delay.attr("stamp")):new Date;stamp=stamp.getTime();var body=$(message).find("body:first").text();if(!body||body.match(/\?OTR/i))return!0;var textarea=jsxc.gui.window.get(bid).find(".jsxc_textarea");if(0===textarea.find('[id="'+messageId+'"]').length){var pseudoChatElement=$("<div>");pseudoChatElement.attr("id",messageId.replace(/:/g,"-")),pseudoChatElement.attr("data-queryId",queryId);var lastMessage=textarea.find('[data-queryId="'+queryId+'"]').last(),history=jsxc.storage.getUserItem("history",bid)||[];history.indexOf(messageId)<0&&(0===lastMessage.length?(textarea.prepend(pseudoChatElement),history.push(messageId)):(lastMessage.after(pseudoChatElement),history.splice(history.indexOf(lastMessage.attr("id").replace(/-/g,":")),0,messageId))),jsxc.storage.setUserItem("history",bid,history)}jsxc.gui.window.postMessage({_uid:messageId,bid:bid,sender:direction.from,direction:direction.way,msg:body,encrypted:!1,forwarded:!0,stamp:stamp})}}}},jsxc.xmpp.mam.getMessageDirection=function(bid,message){var direction=null,type=message.attr("type"),from=message.attr("from");if("groupchat"===type){var jid=message.find("item").attr("jid"),userBid=jsxc.jidToBid(jid),nickname=Strophe.unescapeNode(Strophe.getResourceFromJid(from));direction={way:userBid===jsxc.bid?jsxc.Message.OUT:jsxc.Message.IN,from:{jid:jid,name:nickname}}}else if("chat"===type){var to=message.attr("to");if(jsxc.jidToBid(from)!==bid&&jsxc.jidToBid(to)!==bid)return null;var buddy=jsxc.storage.getUserItem("buddy",jsxc.jidToBid(from)),name=null!==buddy&&buddy.name||null;direction={way:jsxc.jidToBid(to)===bid?jsxc.Message.OUT:jsxc.Message.IN,from:{jid:from,name:name}}}return direction},jsxcLanguageResources.fr.translation.ClearHistory="Effacer l'historique local des conversations",jsxcLanguageResources.en.translation.ClearHistory="Clear the talk history",jsxcLanguageResources.de.translation.ClearHistory="Löschen Sie den Diskussionsverlauf",jsxcLanguageResources.fr.translation.Buddies="Contacts",jsxcLanguageResources.en.translation.Buddies="Buddies",jsxcLanguageResources.de.translation.Buddies="Kontakte",jsxcLanguageResources.fr.translation["Group Chats"]="Groupes",jsxcLanguageResources.en.translation["Group Chats"]="Group Chats",jsxcLanguageResources.de.translation["Group Chats"]="Gruppe Chat",jsxcLanguageResources.fr.translation.Group_Chat="Groupe de discussion",jsxcLanguageResources.en.translation.Group_Chat="Group Chat",jsxcLanguageResources.de.translation.Group_Chat="Gruppe Chat",jsxcLanguageResources.fr.translation.Menu="Menu",jsxcLanguageResources.en.translation.Menu="Menu",jsxcLanguageResources.de.translation.Menu="Menu",jsxcLanguageResources.fr.translation.Search_user="Rechercher un utilisateur",jsxcLanguageResources.en.translation.Search_user="Looking for a user",jsxcLanguageResources.de.translation.Search_user="Benutzer ein suchen",jsxcLanguageResources.fr.translation.Notifications="Notifications",jsxcLanguageResources.en.translation.Notifications="Notifications",jsxcLanguageResources.de.translation.Notifications="Benachrichtigungen",jsxcLanguageResources.fr.translation.New_Chat="Nouvelle discussion",jsxcLanguageResources.en.translation.New_Chat="New chat",jsxcLanguageResources.de.translation.New_Chat="Neuer Chat",jsxcLanguageResources.fr.translation.Help_New_Group_Chat="Sélectionnez d'abord les contacts à inviter par Ctrl+Clic pour pouvoir créer un groupe de discussion",jsxcLanguageResources.en.translation.Help_New_Group_Chat="Please select first the buddies by Ctrl+Click to invite before creating any group chat",jsxcLanguageResources.de.translation.Help_New_Group_Chat="Wählen Sie zuerst die Kontakte aus, die Sie mit Ctrl+Klick einladen möchten, um eine Gruppendiskussion zu erstellen",jsxcLanguageResources.fr.translation.Help_Invite="Sélectionnez d'abord le ou les contacts à inviter par un Ctrl+Clic. Vous pouvez aussi glisser/déposer le contact dans le groupe",jsxcLanguageResources.en.translation.Help_Invite="Please select first the buddies to invite by Ctrl+Click. You can also drag&drop the buddy in the group chat window",jsxcLanguageResources.de.translation.Help_Invite="Wählen Sie zuerst die Kontakte aus, die Sie mit Ctrl+Klick einladen möchten. Sie können den Buddy auch per Drag & Drop in das Gruppenchatfenster ziehen",jsxcLanguageResources.fr.translation.New_Group_Chat="Nouveau groupe de discussion",jsxcLanguageResources.en.translation.New_Group_Chat="New group chat",jsxcLanguageResources.de.translation.New_Group_Chat="Neuer Gruppe Chat",jsxcLanguageResources.fr.translation.Invite_To_Group_Chat="Inviter dans le groupe de discussion",jsxcLanguageResources.en.translation.Invite_To_Group_Chat="Invite to the group chat",jsxcLanguageResources.de.translation.Invite_To_Group_Chat="Laden Sie zum Gruppe Chat ein",jsxcLanguageResources.fr.translation.Select_Buddy="Sélectionner le contact",jsxcLanguageResources.en.translation.Select_Buddy="Select the buddy",jsxcLanguageResources.de.translation.Select_Buddy="Wählen Sie den Kontakt aus",jsxcLanguageResources.fr.translation.Unselect_Buddy="Désélectionner le contact",jsxcLanguageResources.en.translation.Unselect_Buddy="Unselect the buddy",jsxcLanguageResources.de.translation.Unselect_Buddy="Deaktivieren Sie den Kontakt",jsxcLanguageResources.fr.translation.New_invitation="__sender__ vous invite à rejoindre le groupe de discussion __room__",jsxcLanguageResources.en.translation.New_invitation="__sender__ invite you to join him the group chat __room__",jsxcLanguageResources.de.translation.New_invitation="__sender__ lädt Sie ein, sich dem Gruppe Chat __room__ anzuschließen",jsxcLanguageResources.fr.translation.Chat_room_name_pattern="Pas d'espaces, pas de caractères accentués ou spéciaux (&\"'/:,;!?<>@)",jsxcLanguageResources.en.translation.Chat_room_name_pattern="No spaces, no accented or special characters (&\"'/:,;!?<>@)",jsxcLanguageResources.de.translation.Chat_room_name_pattern="Keine Leerzeichen, keine akzentuierten oder Sonderzeichen (&\"'/:,;!? <> @)",jsxcLanguageResources.fr.translation.Search_User="Rechercher un utilisateur par son identifiant",jsxcLanguageResources.en.translation.Search_User="Search a user by its identifier",jsxcLanguageResources.de.translation.Search_User="Suchen Sie einen Benutzer nach seinem Bezeichner",jsxcLanguageResources.fr.translation.You_have_received_message_from_="Vous avez reçu un message de ",jsxcLanguageResources.en.translation.You_have_received_message_from_="You have received a message from ",jsxcLanguageResources.de.translation.You_have_received_message_from_="Du hast eine Nachricht von ",jsxcLanguageResources.fr.translation.Events="Événements",jsxcLanguageResources.en.translation.Events="Events",jsxcLanguageResources.de.translation.Events="Ereignisse",jsxcLanguageResources.fr.translation["message_not_send_resource-unavailable"]="Votre message n'a pas été envoyé parce que votre interlocuteur n'est pas connecté ou accessible",jsxcLanguageResources.fr.translation.left_the_building="__nickname__ a quitté le groupe de discussion",jsxcLanguageResources.en.translation.left_the_building="__nickname__ left the chat group",jsxcLanguageResources.de.translation.left_the_building="__nickname__ hat die Gruppe verlassen",jsxcLanguageResources.fr.translation.entered_the_room="__nickname__ entre dans le groupe de discussion",jsxcLanguageResources.en.translation.entered_the_room="__nickname__ entered the chat group",jsxcLanguageResources.de.translation.entered_the_room="__nickname__ ist der Gruppe beigetreten"}}(jQuery);
//# sourceMappingURL=silverchat.min.js.map